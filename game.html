<!DOCTYPE html>
<html>
<head>
    <title>Game</title>
    <script src="js/p5.min.js"></script>
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="map.js"></script>
    <script src="cats.js"></script>
    <script src="pens.js"></script>
    <script>
        var c, map, cats, pens;
        var tileWidth = 80;
        var tileHeight = 40;
        
        function initMap() {
            map = mapJSON.map;
        }

        function initCats() {
            cats = catsJSON.cats;
            for (i = 0; i < cats.length; i++) {
                cats[i].next = cats[i].path.shift();
                cats[i].perc_moved = 0;
            }
        }
        
        function initPens() {
            pens = pensJSON.pens;
        }

        function drawSingleTile(tileType,x1,y1,x2,y2,x3,y3,x4,y4) {
            // change the fill or whatever based on tileType
            fill(c);
            quad(x1,y1,x2,y2,x3,y3,x4,y4);
        }

        function drawTiles() {
            numRows = map.length;
            numCols = map[0].length;
            push();
            translate(tileWidth/2, numRows*tileHeight/2);
            for (y = 0; y< numRows; y++){
                for (x = 0; x< numCols; x++){
                    drawSingleTile(0, -tileWidth/2, 0, 0, tileHeight/2, tileWidth/2, 0, 0, -tileHeight/2);
                    translate(tileWidth/2, -tileHeight/2);
                }
                translate(-numCols*tileWidth/2,numCols*tileHeight/2);
                translate(tileWidth/2, tileHeight/2);
            }
            pop();
        }
        
        function gameOver(endCode) {
            if (endCode == 1) {
                // alert("You Lose");
            }
            if (endCode == 0) {
                console.log("You Win!");
            }
        }
        
        // called once per draw
        function updateCats() {
            cats.forEach(function(cat) {
                cat.perc_moved++;
                if (cat.perc_moved >= 100) {
                    cat.perc_moved = 0;
                    
                    cat.pos = cat.next;
                    
                    if ((cat.path.length == 0) || (map[cat.pos.x][cat.pos.y].is_locked)) {
                        cat.next = cat.pos;     
                    } else {
                        cat.next = cat.path.shift();
                    }
                }
                
                // check lose condition: multi-cats
                map[cat.pos.x][cat.pos.y].pen_ids.forEach(function(pen_id) {
                    pens[pen_id].no_cats_in++;
                    if (pens[pen_id].no_cats_in > pens[pen_id].no_cats_allowed) {
                        gameOver(1);
                    }
                });
            });
        }
        
        function drawCat(cat) {
            push();
            numRows = map.length;
            numCols = map[0].length;
            translate(tileWidth/2, numRows*tileHeight/2);
            cx = (cat.pos.x+cat.pos.y)*tileWidth/2;
            cy = (cat.pos.y-cat.pos.x)*tileHeight/2;
            cnx = (cat.next.x+cat.next.y)*tileWidth/2;
            cny = (cat.next.y-cat.next.x)*tileHeight/2;
            
            dx = cx*(100 - cat.perc_moved)/100 + cnx*(cat.perc_moved)/100;
            dy = cy*(100 - cat.perc_moved)/100 + cny*(cat.perc_moved)/100;
            
            fill(255,0,0);
            ellipse(dx,dy,50,25);
            pop();
        }
        
        function mousePressed() {
            console.log(mouseX);
            console.log(mouseY);
        }
        
        function setup() {
            c = color(0,0,255);
            initMap();
            initCats();
            initPens();
            createCanvas(1000, 1000);
            background(200);
        }

        function draw() {
            updateCats();

            drawTiles();
            for (i = 0; i < cats.length; i++) {
                drawCat(cats[i]);
            }
        }
    </script>
</head>
<body>
</body>
</html>
