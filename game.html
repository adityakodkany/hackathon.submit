<!DOCTYPE html>
<html>
<head>
    <title>Game</title>
    <script src="js/p5.min.js"></script>
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="map.js"></script>
    <script src="cats.js"></script>
    <script src="pens.js"></script>
    <script>
        var c, map, cats, pens;
        var tileWidth = 128;
        var tileHeight = 64;
        var tiles = {};
        
        function initMap() {
            map = mapJSON.map;
            map.grid = [];
            for (y = 0; y< map.numRows; y++){
                map.grid[y] = [];
                for (x = 0; x< map.numCols; x++){
                    map.grid[y][x] = {
                        tile_base: 0,
                        grass : Math.floor(Math.random()*3),
                        path: null,
                        locks: [],
                        pens: []
                    }
                }
            }
        }

        function initCats() {
            cats = mapJSON.cats;
            for (i = 0; i < cats.length; i++) {
                cats[i].next = cats[i].path.shift();
                cats[i].perc_moved = 0;
            }
        }
        
        function initPens() {
            pens = mapJSON.pens;
        }
        
        function initTiles() {
            tiles.grass_tex = loadImage("images/tiles_grass_tex.png");
            tiles.grass = [];
            tiles.grass[0] = loadImage("images/tiles_grass_1.png");
            tiles.grass[1] = loadImage("images/tiles_grass_2.png");
            tiles.grass[2] = loadImage("images/tiles_grass_3.png");
            tiles.path = [];
            tiles.path[0] = loadImage("images/tiles_path_1.png");
            tiles.path[1] = loadImage("images/tiles_path_2.png");
            tiles.path[2] = loadImage("images/tiles_path_3.png");
            tiles.path[3] = loadImage("images/tiles_path_4.png");
            tiles.path[4] = loadImage("images/tiles_path_5.png");
            tiles.path[5] = loadImage("images/tiles_path_6.png");
        }

        function drawSingleTile(tile,w, h) {
            push();
            scale(0.5,0.5);
            if (tile.tile_base == 0) {
                var img = tiles.grass_tex;
                image(img, -img.width/2, -img.height/2);
            }
            if (tile.path != undefined && tile.path != null) {
                var img = tiles.path[tile.path];
                image(img, -img.width/2, -img.height/2);
            }
            if (tile.grass != undefined && tile.grass != null) {
                var img = tiles.grass[tile.grass];
                image(img, -img.width/2, -img.height/2);
            }
            pop();
        }

        function drawTiles() {
            push();
            translate(tileWidth/2, numRows*tileHeight/2);
            for (y = 0; y< numRows; y++){
                for (x = 0; x< numCols; x++){
                    drawSingleTile(map[y][x], tileWidth, tileHeight);
                    translate(tileWidth/2, -tileHeight/2);
                }
                translate(-numCols*tileWidth/2,numCols*tileHeight/2);
                translate(tileWidth/2, tileHeight/2);
            }
            pop();
        }
        
        function getTile(x, y) {
            var tile = {};
            mx = mouseX;
            my = mouseY;
            x = (mx - (tileWidth/2));
        }
        
        function gameOver(endCode) {
            if (endCode == 1) {
                // alert("You Lose");
            }
            if (endCode == 0) {
                console.log("You Win!");
            }
        }
        
        // called once per draw
        function updateCats() {
            cats.forEach(function(cat) {
                cat.perc_moved++;
                if (cat.perc_moved >= 100) {
                    cat.perc_moved = 0;
                    
                    cat.pos = cat.next;
                    
                    if ((cat.path.length == 0) || (map[cat.pos.x][cat.pos.y].is_locked)) {
                        cat.next = cat.pos;     
                    } else {
                        cat.next = cat.path.shift();
                    }
                }
                
                // check lose condition: multi-cats
                map[cat.pos.x][cat.pos.y].pen_ids.forEach(function(pen_id) {
                    pens[pen_id].no_cats_in++;
                    if (pens[pen_id].no_cats_in > pens[pen_id].no_cats_allowed) {
                        gameOver(1);
                    }
                });
            });
        }
        
        function drawCat(cat) {
            push();
            numRows = map.length;
            numCols = map[0].length;
            translate(tileWidth/2, numRows*tileHeight/2);
            cx = (cat.pos.x+cat.pos.y)*tileWidth/2;
            cy = (cat.pos.y-cat.pos.x)*tileHeight/2;
            cnx = (cat.next.x+cat.next.y)*tileWidth/2;
            cny = (cat.next.y-cat.next.x)*tileHeight/2;
            
            dx = cx*(100 - cat.perc_moved)/100 + cnx*(cat.perc_moved)/100;
            dy = cy*(100 - cat.perc_moved)/100 + cny*(cat.perc_moved)/100;
            
            fill(255,0,0);
            ellipse(dx,dy,50,25);
            pop();
        }
        
        function mousePressed() {
            var tile = getTile(mouseX, mouseY);
            // setLock(tile.x, tile.y);
        }
        
        function preload(){
            initTiles();
            initMap();
            initCats();
            initPens();
        }
        
        function setup() {
            createCanvas(windowWidth-4, windowHeight-4);
        }

        function update(){
            updateCats();
        }

        function draw() {
            //update
            update();

            /****** drawing logic ****/
            
            //clear canvas
            background(255);
            
            drawTiles();
            for (i = 0; i < cats.length; i++) {
                drawCat(cats[i]);
            }
        }
    </script>
</head>
<body>
</body>
</html>
